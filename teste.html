<script>
const BACKEND_URL = "https://teste-qi-backend-om69.onrender.com";

// ================== PERGUNTAS ==================
const QUESTIONS = [
  {q:"Se 2 + 2 = ?",a:["3","4","5","6"],c:1},
  {q:"Qual número completa a sequência: 2,4,8,16,...",a:["18","20","24","32"],c:3},
  {q:"Qual é o oposto lógico de 'todos'?",a:["alguns","nenhum","vários","muitos"],c:1},
  {q:"Se João é mais alto que Ana e Ana é mais alta que Pedro, quem é o mais baixo?",a:["João","Ana","Pedro","Iguais"],c:2},
  {q:"Quantos graus há em um ângulo reto?",a:["45°","90°","120°","180°"],c:1},
  // (... as demais questões, mantidas iguais ...)
];

// ================== LÓGICA DO TESTE ==================
let current = 0, correct = 0, answers = new Array(QUESTIONS.length).fill(null);
const qtext = document.getElementById('qtext');
const opts = document.getElementById('opts');
const bar = document.getElementById('bar');
const prog = document.getElementById('progress');
const paywall = document.getElementById('paywall');
const overlay = document.getElementById('overlay');
const iqNum = document.getElementById('iqNum');
const clickSound = document.getElementById('clickSound');
let allowSound = true;

document.getElementById('toggleSound').addEventListener('change', e => allowSound = e.target.checked);
function metallicClick(){ if(allowSound){ try{ clickSound.currentTime=0; clickSound.play(); }catch(e){} } }

function render(){
  const item = QUESTIONS[current];
  qtext.textContent = `${current+1}/${QUESTIONS.length} — ${item.q}`;
  opts.innerHTML = "";
  item.a.forEach((t,i)=>{
    const div = document.createElement('label');
    div.className = 'option';
    div.innerHTML = `<span class='badge'>${['A','B','C','D'][i]}</span> ${t}`;
    div.onclick = () => select(i);
    opts.appendChild(div);
  });
  updateProgress();
}

function updateProgress(){
  const p = Math.round((current / QUESTIONS.length) * 100);
  bar.style.width = p + "%";
  prog.textContent = p + "%";
}

function select(i){
  metallicClick();
  answers[current] = i;
  if(i === QUESTIONS[current].c) correct++;
  if(current < QUESTIONS.length - 1){ current++; render(); } else finish();
}

function finish(){
  clearInterval(window._tick);
  document.getElementById('quiz').style.display = 'none';
  paywall.style.display = 'flex';
  bar.style.width = "100%";
  prog.textContent = "100%";
  const iq = Math.round(100 + 15 * ((correct - QUESTIONS.length/2) / (QUESTIONS.length * 0.18)));
  localStorage.setItem('qi_est', iq);
}

// ================== PAGAMENTO ==================
async function liberarResultado(orderId) {
  const res = await fetch(`${BACKEND_URL}/result/${orderId}`);
  const data = await res.json();
  if (res.ok) {
    overlay.style.display = "flex";
    iqNum.textContent = data.result.score;
  } else {
    alert("Pagamento pendente. Aguarde a aprovação.");
  }
}

async function iniciarPix() {
  const res = await fetch(`${BACKEND_URL}/create-pix`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      amount: 3.99,
      description: "Resultado Teste de QI Premium",
      correct,
      total: QUESTIONS.length
    })
  });
  const data = await res.json();

  if (data.qr_code_base64) {
    const qrWrap = document.getElementById("qrWrap");
    const qrImg = document.getElementById("qrImg");
    const copyPix = document.getElementById("copyPix");
    qrWrap.style.display = "flex";
    qrImg.src = `data:image/png;base64,${data.qr_code_base64}`;
    copyPix.onclick = () => navigator.clipboard.writeText(data.qr_code);

    const check = setInterval(async () => {
      const s = await fetch(`${BACKEND_URL}/payment-status/${data.id}`).then(r => r.json());
      if (s.status === "approved") {
        clearInterval(check);
        liberarResultado(data.orderId);
      }
    }, 5000);
  }
}

async function iniciarCartao() {
  const res = await fetch(`${BACKEND_URL}/create-order`, { method: "POST" });
  const data = await res.json();

  if (data.init_point) {
    window.open(data.init_point, "_blank");
    const check = setInterval(async () => {
      const s = await fetch(`${BACKEND_URL}/payment-status/${data.orderId}`).then(r => r.json());
      if (s.status === "approved") {
        clearInterval(check);
        liberarResultado(data.orderId);
      }
    }, 5000);
  }
}

// liga botões
document.getElementById("btnPix").onclick = iniciarPix;
document.getElementById("btnCard").onclick = iniciarCartao;

// ================== TIMER ==================
let sec = 600;
window._tick = setInterval(()=>{
  sec--;
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  document.getElementById('timer').textContent = `${m}:${s}`;
  if(sec <= 0) finish();
}, 1000);

render();
</script>
